# https://taskfile.dev
version: '3'

vars:
  VERSION:    { sh: $(git describe --tags --long 2>/dev/null) || echo "no-version-yet" }
  BUILD_DATE: { sh: date -u +'%Y-%m-%dT%H:%M:%SZ' }

tasks:
  install:
    desc: "install local remapjson binary"
    vars:
      GOPATH: { sh: go env GOPATH }
      GOOS:   { sh: go env GOOS }
      GOARCH: { sh: go env GOARCH }
    cmds:
      - {task: 'build:{{.GOARCH}}-{{.GOOS}}' }
      - cp ./bin/remapjson-{{.GOOS}}-{{.GOARCH}} {{.GOPATH}}/bin/remapjson

  build:
    desc: "build everything"
    cmds:
    - task: build:clear
    - task: build:bin:all
    - task: build:docker

  build:bin:all:
    internal: true
    desc: "build binaries for all platforms"
    deps:
      - build:bin:amd64-linux
      - build:bin:arm64-darwin
      - build:bin:amd64-darwin
      - build:bin:amd64-windows

  build:bin:amd64-windows:
    desc: "build for amd64-windows"
    deps: [{ task: build:bin:nospec, vars: { GOARCH: amd64, GOOS: windows } }]

  build:bin:amd64-linux:
    desc: "build for amd64-linux"
    deps: [{ task: build:bin:nospec, vars: { GOARCH: amd64, GOOS: linux } }]

  build:bin:arm64-darwin:
    desc: "build for M1 darwin"
    deps: [{ task: build:bin:nospec, vars: { GOARCH: arm64, GOOS: darwin } }]

  build:bin:amd64-darwin:
    desc: "build for amd64-darwin"
    deps: [{ task: build:bin:nospec, vars: { GOARCH: amd64, GOOS: darwin } }]

  build:bin:nospec:
    desc: "build without spec, for internal use"
    internal: true
    silent: false
    cmds:
      - {silent: true, cmd: 'mkdir -p ./bin'}
      - |
        GOOS={{.GOOS}} GOARCH={{.GOARCH}} go build \
        -o ./bin/remapjson-{{.GOOS}}-{{.GOARCH}} \
        {{.FLAGS}} \
        -ldflags "-X 'main.version={{.VERSION}}-local' -X 'main.buildDate={{.BUILD_DATE}}' -s -w" \
        main.go

  build:clear:
    desc: "clear build artifacts"
    cmd: rm -rf ./bin

  build:docker:
    desc: "build docker image with local binary"
    cmd: docker build -t remapjson:local .

  check:
    desc: "run all checks"
    deps: [lint, test]

  lint:
    desc: "run linters"
    cmd: golangci-lint run --timeout 5m

  test:
    desc: "run tests"
    cmd: go test -timeout=60s ./...

  run:
    desc: "run app with .env, pass additional args through double-dash --"
    dotenv: [.env]
    cmd: |
      go run -ldflags "-X 'main.version=local' -X 'main.buildDate={{.BUILD_DATE}}' -s -w" main.go {{.CLI_ARGS}}
